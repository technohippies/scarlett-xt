import"./_virtual_wxt-html-plugins-DPbbfBKe.js";import{R as r,r as s,b as Q,j as a,B as z,c as te,i as ce,k as ie,d as de,l as ue,a as ge,h as fe}from"./db-BxpoVJEC.js";import{s as H,o as me}from"./messaging-BNKTJYrr.js";import{w as pe,a as he,T as D,I as xe,k as ve}from"./textarea-wOhmCvPD.js";import{P as be}from"./index-h0nugIKd.js";const we=new Map([["bold",r.createElement(r.Fragment,null,r.createElement("path",{d:"M244,56v48a12,12,0,0,1-12,12H184a12,12,0,1,1,0-24H201.1l-19-17.38c-.13-.12-.26-.24-.38-.37A76,76,0,1,0,127,204h1a75.53,75.53,0,0,0,52.15-20.72,12,12,0,0,1,16.49,17.45A99.45,99.45,0,0,1,128,228h-1.37A100,100,0,1,1,198.51,57.06L220,76.72V56a12,12,0,0,1,24,0Z"}))],["duotone",r.createElement(r.Fragment,null,r.createElement("path",{d:"M216,128a88,88,0,1,1-88-88A88,88,0,0,1,216,128Z",opacity:"0.2"}),r.createElement("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"}))],["fill",r.createElement(r.Fragment,null,r.createElement("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1-5.66-13.66l17-17-10.55-9.65-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,1,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60l10.93,10L226.34,50.3A8,8,0,0,1,240,56Z"}))],["light",r.createElement(r.Fragment,null,r.createElement("path",{d:"M238,56v48a6,6,0,0,1-6,6H184a6,6,0,0,1,0-12h32.55l-30.38-27.8c-.06-.06-.12-.13-.19-.19a82,82,0,1,0-1.7,117.65,6,6,0,0,1,8.24,8.73A93.46,93.46,0,0,1,128,222h-1.28A94,94,0,1,1,194.37,61.4L226,90.35V56a6,6,0,1,1,12,0Z"}))],["regular",r.createElement(r.Fragment,null,r.createElement("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"}))],["thin",r.createElement(r.Fragment,null,r.createElement("path",{d:"M236,56v48a4,4,0,0,1-4,4H184a4,4,0,0,1,0-8h37.7L187.53,68.69l-.13-.12a84,84,0,1,0-1.75,120.51,4,4,0,0,1,5.5,5.82A91.43,91.43,0,0,1,128,220h-1.26A92,92,0,1,1,193,62.84l35,32.05V56a4,4,0,1,1,8,0Z"}))]]),je=new Map([["bold",r.createElement(r.Fragment,null,r.createElement("path",{d:"M236,128a108,108,0,0,1-216,0c0-42.52,24.73-81.34,63-98.9A12,12,0,1,1,93,50.91C63.24,64.57,44,94.83,44,128a84,84,0,0,0,168,0c0-33.17-19.24-63.43-49-77.09A12,12,0,1,1,173,29.1C211.27,46.66,236,85.48,236,128Z"}))],["duotone",r.createElement(r.Fragment,null,r.createElement("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"}),r.createElement("path",{d:"M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"}))],["fill",r.createElement(r.Fragment,null,r.createElement("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,176A72,72,0,0,1,92,65.64a8,8,0,0,1,8,13.85,56,56,0,1,0,56,0,8,8,0,0,1,8-13.85A72,72,0,0,1,128,200Z"}))],["light",r.createElement(r.Fragment,null,r.createElement("path",{d:"M230,128a102,102,0,0,1-204,0c0-40.18,23.35-76.86,59.5-93.45a6,6,0,0,1,5,10.9C58.61,60.09,38,92.49,38,128a90,90,0,0,0,180,0c0-35.51-20.61-67.91-52.5-82.55a6,6,0,0,1,5-10.9C206.65,51.14,230,87.82,230,128Z"}))],["regular",r.createElement(r.Fragment,null,r.createElement("path",{d:"M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"}))],["thin",r.createElement(r.Fragment,null,r.createElement("path",{d:"M228,128a100,100,0,0,1-200,0c0-39.4,22.9-75.37,58.33-91.63a4,4,0,1,1,3.34,7.27C57.07,58.6,36,91.71,36,128a92,92,0,0,0,184,0c0-36.29-21.07-69.4-53.67-84.36a4,4,0,1,1,3.34-7.27C205.1,52.63,228,88.6,228,128Z"}))]]),ye=new Map([["bold",r.createElement(r.Fragment,null,r.createElement("path",{d:"M250.73,210.63l-56-112a12,12,0,0,0-21.46,0l-20.52,41A84.2,84.2,0,0,1,114,126.22,107.48,107.48,0,0,0,139.33,68H160a12,12,0,0,0,0-24H108V32a12,12,0,0,0-24,0V44H32a12,12,0,0,0,0,24h83.13A83.69,83.69,0,0,1,96,110.35,84,84,0,0,1,83.6,91a12,12,0,1,0-21.81,10A107.55,107.55,0,0,0,78,126.24,83.54,83.54,0,0,1,32,140a12,12,0,0,0,0,24,107.47,107.47,0,0,0,64-21.07,108.4,108.4,0,0,0,45.39,19.44l-24.13,48.26a12,12,0,1,0,21.46,10.73L151.41,196h65.17l12.68,25.36a12,12,0,1,0,21.47-10.73ZM163.41,172,184,130.83,204.58,172Z"}))],["duotone",r.createElement(r.Fragment,null,r.createElement("path",{d:"M224,184H144l40-80ZM96,127.56h0A95.78,95.78,0,0,0,128,56H64A95.78,95.78,0,0,0,96,127.56Z",opacity:"0.2"}),r.createElement("path",{d:"M247.15,212.42l-56-112a8,8,0,0,0-14.31,0l-21.71,43.43A88,88,0,0,1,108,126.93,103.65,103.65,0,0,0,135.69,64H160a8,8,0,0,0,0-16H104V32a8,8,0,0,0-16,0V48H32a8,8,0,0,0,0,16h87.63A87.7,87.7,0,0,1,96,116.35a87.74,87.74,0,0,1-19-31,8,8,0,1,0-15.08,5.34A103.63,103.63,0,0,0,84,127a87.55,87.55,0,0,1-52,17,8,8,0,0,0,0,16,103.46,103.46,0,0,0,64-22.08,104.18,104.18,0,0,0,51.44,21.31l-26.6,53.19a8,8,0,0,0,14.31,7.16L148.94,192h70.11l13.79,27.58A8,8,0,0,0,240,224a8,8,0,0,0,7.15-11.58ZM156.94,176,184,121.89,211.05,176Z"}))],["fill",r.createElement(r.Fragment,null,r.createElement("path",{d:"M160,129.89,175.06,160H144.94l6.36-12.7v0ZM224,48V208a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32H208A16,16,0,0,1,224,48ZM207.16,188.42l-40-80a8,8,0,0,0-14.32,0L139.66,134.8a62.31,62.31,0,0,1-23.61-10A79.61,79.61,0,0,0,135.6,80H152a8,8,0,0,0,0-16H112V56a8,8,0,0,0-16,0v8H56a8,8,0,0,0,0,16h63.48a63.73,63.73,0,0,1-15.3,34.05,65.93,65.93,0,0,1-9-13.61,8,8,0,0,0-14.32,7.12,81.75,81.75,0,0,0,11.4,17.15A63.62,63.62,0,0,1,56,136a8,8,0,0,0,0,16,79.56,79.56,0,0,0,48.11-16.13,78.33,78.33,0,0,0,28.18,13.66l-19.45,38.89a8,8,0,0,0,14.32,7.16L136.94,176h46.12l9.78,19.58a8,8,0,1,0,14.32-7.16Z"}))],["light",r.createElement(r.Fragment,null,r.createElement("path",{d:"M245.37,213.32l-56-112a6,6,0,0,0-10.74,0l-22.3,44.6A90,90,0,0,1,105,127.19,101.73,101.73,0,0,0,133.82,62H160a6,6,0,0,0,0-12H102V32a6,6,0,0,0-12,0V50H32a6,6,0,0,0,0,12h89.79A89.71,89.71,0,0,1,96,119.23,89.81,89.81,0,0,1,75.11,86,6,6,0,1,0,63.8,90,101.66,101.66,0,0,0,87,127.2,89.56,89.56,0,0,1,32,146a6,6,0,0,0,0,12,101.55,101.55,0,0,0,64-22.63,102.11,102.11,0,0,0,54.53,22.17l-27.89,55.78a6,6,0,0,0,10.74,5.36L147.71,190h72.58l14.34,28.68A6,6,0,0,0,240,222a5.87,5.87,0,0,0,2.68-.64A6,6,0,0,0,245.37,213.32ZM153.71,178,184,117.42,214.29,178Z"}))],["regular",r.createElement(r.Fragment,null,r.createElement("path",{d:"M247.15,212.42l-56-112a8,8,0,0,0-14.31,0l-21.71,43.43A88,88,0,0,1,108,126.93,103.65,103.65,0,0,0,135.69,64H160a8,8,0,0,0,0-16H104V32a8,8,0,0,0-16,0V48H32a8,8,0,0,0,0,16h87.63A87.76,87.76,0,0,1,96,116.35a87.74,87.74,0,0,1-19-31,8,8,0,1,0-15.08,5.34A103.63,103.63,0,0,0,84,127a87.55,87.55,0,0,1-52,17,8,8,0,0,0,0,16,103.46,103.46,0,0,0,64-22.08,104.18,104.18,0,0,0,51.44,21.31l-26.6,53.19a8,8,0,0,0,14.31,7.16L148.94,192h70.11l13.79,27.58A8,8,0,0,0,240,224a8,8,0,0,0,7.15-11.58ZM156.94,176,184,121.89,211.05,176Z"}))],["thin",r.createElement(r.Fragment,null,r.createElement("path",{d:"M243.58,214.21l-56-112a4,4,0,0,0-7.16,0L157.55,148A92.05,92.05,0,0,1,102,127.36,99.68,99.68,0,0,0,131.91,60H160a4,4,0,0,0,0-8H100V32a4,4,0,0,0-8,0V52H32a4,4,0,0,0,0,8h91.91A91.8,91.8,0,0,1,96,122.05,92,92,0,0,1,73.23,86.67a4,4,0,1,0-7.54,2.66,99.59,99.59,0,0,0,24.3,38A91.59,91.59,0,0,1,32,148a4,4,0,0,0,0,8,99.54,99.54,0,0,0,64-23.21,100.09,100.09,0,0,0,57.66,23l-29.22,58.43a4,4,0,1,0,7.16,3.58L146.47,188h75.06l14.89,29.79A4,4,0,0,0,240,220a4.12,4.12,0,0,0,1.79-.42A4,4,0,0,0,243.58,214.21ZM150.47,180,184,112.94,217.53,180Z"}))]]);var Ae=Object.defineProperty,Ee=Object.defineProperties,Ce=Object.getOwnPropertyDescriptors,U=Object.getOwnPropertySymbols,ke=Object.prototype.hasOwnProperty,Ne=Object.prototype.propertyIsEnumerable,W=(t,e,n)=>e in t?Ae(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Se=(t,e)=>{for(var n in e||(e={}))ke.call(e,n)&&W(t,n,e[n]);if(U)for(var n of U(e))Ne.call(e,n)&&W(t,n,e[n]);return t},ze=(t,e)=>Ee(t,Ce(e));const V=s.forwardRef((t,e)=>r.createElement(Q,ze(Se({ref:e},t),{weights:we})));V.displayName="ArrowClockwise";var Fe=Object.defineProperty,Me=Object.defineProperties,Te=Object.getOwnPropertyDescriptors,X=Object.getOwnPropertySymbols,$e=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable,Y=(t,e,n)=>e in t?Fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Re=(t,e)=>{for(var n in e||(e={}))$e.call(e,n)&&Y(t,n,e[n]);if(X)for(var n of X(e))Pe.call(e,n)&&Y(t,n,e[n]);return t},He=(t,e)=>Me(t,Te(e));const re=s.forwardRef((t,e)=>r.createElement(Q,He(Re({ref:e},t),{weights:je})));re.displayName="CircleNotch";var Ie=Object.defineProperty,Le=Object.defineProperties,Oe=Object.getOwnPropertyDescriptors,ee=Object.getOwnPropertySymbols,Ze=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable,ae=(t,e,n)=>e in t?Ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ve=(t,e)=>{for(var n in e||(e={}))Ze.call(e,n)&&ae(t,n,e[n]);if(ee)for(var n of ee(e))Be.call(e,n)&&ae(t,n,e[n]);return t},_e=(t,e)=>Le(t,Oe(e));const J=s.forwardRef((t,e)=>r.createElement(Q,_e(Ve({ref:e},t),{weights:ye})));J.displayName="Translate";function De({pageTitle:t,pageUrl:e,status:n,isSaving:c,canClip:g,onSaveBookmark:C,saveButtonText:d="Save",statusIsError:N=!1,tagsValue:k="",onTagsChange:S=()=>{},onSettingsClick:b=()=>{}}){const y=c?a.jsx(re,{size:16,className:"h-4 w-4 animate-spin"}):d;return a.jsxs("div",{className:"p-4 w-80 flex flex-col gap-3 bg-background text-foreground border border-border rounded-lg shadow-md",children:[g?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex justify-between items-center mb-2",children:[a.jsxs("div",{className:"flex items-center gap-1 text-lg font-semibold",children:[a.jsx(pe,{size:20,weight:"fill",className:"text-primary"}),a.jsx("span",{children:"Bookmark"})]}),b&&a.jsx("button",{onClick:b,title:"Open Settings",className:"p-1 text-muted-foreground hover:text-foreground focus:outline-none focus:ring-1 focus:ring-ring rounded",children:a.jsx(he,{size:20})})]}),t&&a.jsxs("div",{className:"flex items-center gap-2 text-base",children:[a.jsx("span",{className:"font-medium w-16 shrink-0",children:"Title:"}),a.jsx("span",{className:"truncate flex-1",title:t,children:t})]}),e&&a.jsxs("div",{className:"flex items-center gap-2 text-base",children:[a.jsx("span",{className:"font-medium w-16 shrink-0",children:"Source:"}),a.jsx("span",{className:"truncate flex-1 text-muted-foreground",title:e,children:e})]}),a.jsxs("div",{className:"flex items-center gap-2 text-base",children:[a.jsx("label",{htmlFor:"tags-textarea",className:"font-medium w-16 shrink-0",children:"Tags:"}),a.jsx(D,{id:"tags-textarea",placeholder:"",value:k,onChange:S,className:"resize-none flex-1 min-h-[40px]",rows:1})]}),a.jsx(z,{onClick:C,disabled:!g||c,variant:"default",size:"default",className:`w-full mt-2 ${c?"flex justify-center items-center":""}`,children:y})]}):null,n&&!c&&a.jsx("div",{className:`text-sm text-center mt-1 ${N?"text-destructive":"text-muted-foreground"} ${g?"":"py-8"}`,children:n})]})}var Ge="Label",ne=s.forwardRef((t,e)=>a.jsx(be.label,{...t,ref:e,onMouseDown:n=>{var g;n.target.closest("button, input, select, textarea")||((g=t.onMouseDown)==null||g.call(t,n),!n.defaultPrevented&&n.detail>1&&n.preventDefault())}}));ne.displayName=Ge;var se=ne;const qe=ce("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),K=s.forwardRef(({className:t,...e},n)=>a.jsx(se,{ref:n,className:te(qe(),t),...e}));K.displayName=se.displayName;const Je=({selectedText:t,onSaveFlashcard:e,onGenerate:n,generatedFlashcard:c,generatedCloze:g,onTranslateFlashcard:C,onTranslateCloze:d,translatedFlashcardBack:N,translatedClozeText:k,isTranslatingFlashcard:S,isTranslatingCloze:b})=>{const[y,F]=s.useState(""),[A,m]=s.useState(""),[p,h]=s.useState(""),[x,M]=s.useState(!0),[I,T]=s.useState("."),[E,$]=s.useState(0),[j,L]=s.useState(0),[f,P]=s.useState(!1),[v,_]=s.useState(!1);s.useEffect(()=>{(async()=>{M(!0),F(""),m(""),h(""),console.log("[Popup] Requesting INITIAL generation via onGenerate for:",t);try{await n(t),console.log("[Popup] Initial generation request sent (promise resolved).")}catch(l){console.error("[Popup] Error triggering initial generation via onGenerate:",l)}})()},[t,n]),s.useEffect(()=>{console.log("[Popup] generatedFlashcard prop changed:",c),P(!1),c&&(F(c.front),m(c.back),M(!1))},[c]),s.useEffect(()=>{console.log("[Popup] generatedCloze prop changed:",g),_(!1),g&&(h(g.text),M(!1))},[g]),s.useEffect(()=>{if(E===0)return;(async()=>{P(!0),F(""),m(""),console.log("[Popup] Triggering regeneration (Flashcard) via onGenerate");try{await n(t)}catch(l){console.error("[Popup] Error triggering flashcard regen:",l)}})()},[E,t,n]),s.useEffect(()=>{if(j===0)return;(async()=>{_(!0),h(""),console.log("[Popup] Triggering regeneration (Cloze) via onGenerate");try{await n(t)}catch(l){console.error("[Popup] Error triggering cloze regen:",l)}})()},[j,t,n]),s.useEffect(()=>{let i=null;return(x||f||v)&&(T("."),i=setInterval(()=>{T(l=>l==="..."?".":l+".")},400)),()=>{i&&clearInterval(i)}},[x,f,v]);const G=()=>{const i=N??A,l=k??p;if(!y&&!l){console.warn("[Popup] Cannot save, missing front/cloze content.");return}e({source_highlight:t,type:l?"cloze":"front_back",front:y||void 0,back:i||void 0,cloze_text:l||void 0,target_language:N||k?"zh-CN":void 0,source_url:void 0,context:void 0,tags:void 0})},R=`Generating${I}`,O=x||f||v||S||b,Z=f||S,B=v||b,q=!O&&(y||p);return console.log("[Popup Render Debug]",{isLoadingInitial:x,isRegeneratingFlashcard:f,isRegeneratingCloze:v,flashcardFront:y,clozeText:p,loadingPlaceholder:R}),a.jsxs("div",{className:"max-w-xl h-[540px] p-4 bg-background text-foreground border border-border rounded-lg shadow-md flex flex-col gap-3",children:[a.jsxs("div",{className:"flex-grow overflow-y-auto pr-2 flex flex-col gap-3",children:[a.jsxs("fieldset",{className:"flex flex-col gap-3",children:[a.jsxs("div",{className:"flex justify-between items-center min-h-[36px]",children:[a.jsxs("legend",{className:"text-lg font-semibold px-1 flex items-center gap-2",children:[a.jsx(xe,{size:20,weight:"duotone",className:"text-orange-500"}),"Flashcard"]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(z,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground h-7 w-7",onClick:()=>A&&C(A),disabled:Z||!A,title:"Translate Back (to Chinese)",children:S?a.jsx(V,{size:14,className:"animate-spin"}):a.jsx(J,{size:14})}),a.jsx(z,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground h-7 w-7",onClick:()=>$(i=>i+1),disabled:O||!t,title:"Regenerate Flashcard",children:a.jsx(V,{size:14,className:f?"animate-spin":""})})]})]}),a.jsxs("div",{children:[a.jsx(K,{htmlFor:"flashcard-front",children:"Front"}),a.jsx(D,{id:"flashcard-front",className:"mt-1",value:y,onChange:i=>F(i.target.value),placeholder:x||f?R:"Topic/Concept...",rows:1,disabled:Z})]}),a.jsxs("div",{children:[a.jsx(K,{htmlFor:"flashcard-back",children:"Back"}),a.jsx(D,{id:"flashcard-back",className:"mt-1",value:N??A,onChange:i=>m(i.target.value),placeholder:x||f?R:"Fact/Definition...",disabled:Z})]})]}),a.jsxs("fieldset",{className:"flex flex-col gap-3",children:[a.jsxs("div",{className:"flex justify-between items-center min-h-[36px]",children:[a.jsxs("legend",{className:"text-lg font-semibold px-1 flex items-center gap-2",children:[a.jsx(ve,{size:20,weight:"duotone",className:"text-orange-500"}),"Cloze"]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(z,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground h-7 w-7",onClick:()=>p&&d(p),disabled:B||!p,title:"Translate Cloze Answer (to Chinese)",children:b?a.jsx(V,{size:14,className:"animate-spin"}):a.jsx(J,{size:14})}),a.jsx(z,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground h-7 w-7",onClick:()=>L(i=>i+1),disabled:O||!t,title:"Regenerate Cloze",children:a.jsx(V,{size:14,className:v?"animate-spin":""})})]})]}),a.jsx("div",{className:"space-y-1",children:a.jsx(D,{id:"cloze-text",value:k??p,onChange:i=>h(i.target.value),placeholder:x||v?R:"Sentence with {{c1::cloze}}...",rows:5,disabled:B})})]})]}),a.jsx("div",{className:"flex items-center mt-auto shrink-0 pt-2 gap-2",children:a.jsx(z,{size:"sm",onClick:G,disabled:!q,className:"w-full",children:"Save"})})]})};function Ke(){const[t,e]=s.useState("Initializing..."),[n,c]=s.useState(!1),[g,C]=s.useState(!1),[d,N]=s.useState(null),[k,S]=s.useState(""),[b,y]=s.useState(null),[F,A]=s.useState(!0),[m,p]=s.useState(null),[h,x]=s.useState(null),[M,I]=s.useState(!1),[T,E]=s.useState(null),[$,j]=s.useState(null),[L,f]=s.useState(!1),[P,v]=s.useState(!1);s.useEffect(()=>{console.log("[App] Initializing popup..."),A(!0),e("Loading..."),c(!1),p(null),x(null),I(!1),E(null),j(null),f(!1),v(!1),(async()=>{try{const o=await H("getSelectedText",void 0);if(console.log("[App] Received selected text response:",o),o&&o.text){y(o.text),e(""),A(!1),console.log("[App] Mode: Flashcard Creator");return}console.log("[App] No selected text found, requesting page info...");const u=await H("getPageInfo",void 0);console.log("[App] Received page info:",u),u&&u.title&&u.url?(N(u),e(""),console.log("[App] Mode: Bookmark Clipper")):(console.error("[App] Failed to get page info."),e("Could not retrieve page information."),c(!0))}catch(o){console.error("[App] Error fetching initial data:",o),e(`Error loading data: ${o instanceof Error?o.message:String(o)}`),c(!0)}finally{A(!1)}})()},[]);const _=s.useCallback(l=>{if(M){console.warn("[App] Generation already in progress.");return}console.log("[App] Sending generateFlashcardContent message to background..."),I(!0),E(null),j(null),e("Generating flashcard..."),c(!1),H("generateFlashcardContent",{text:l,sourceUrl:(d==null?void 0:d.url)||null,sourceLanguage:null,targetLanguage:null}).catch(o=>{console.error("[App] Error sending generateFlashcardContent message:",o),e(`Error generating: ${o.message}`),c(!0)}).finally(()=>{console.log("[App] generateFlashcardContent message sent (fire and forget).")})},[d]);s.useEffect(()=>(console.log("[App] Setting up flashcardGenerationResult listener..."),me("flashcardGenerationResult",o=>{console.log("[App] Received flashcardGenerationResult message:",o);const{data:u,error:w}=o.data;I(!1),w?(console.error("[App] Flashcard generation failed:",w),e(`Error: ${w}`),c(!0),p(null),x(null)):u?(p(u.flashcard),x(u.cloze),e("Generation complete."),c(!1)):(console.warn("[App] Received empty flashcard generation result."),e("Received empty result."),c(!0),p(null),x(null)),E(null),j(null),f(!1),v(!1)})),[]);const G=l=>{S(l.target.value)},R=async()=>{if(!d||g)return;C(!0),e("Saving bookmark..."),c(!1);const l=k.split(",").map(o=>o.trim()).filter(Boolean).join(",");try{const o=await ue({url:d.url,title:d.title,tags:l});await ge({role:"bookmark",bookmark_id:o.id}),e("Bookmark saved!"),setTimeout(()=>window.close(),1200)}catch(o){console.error("[PopupApp] Error saving bookmark:",o),e(`Error saving bookmark: ${o instanceof Error?o.message:String(o)}`),c(!0)}finally{C(!1)}},O=async l=>{if(!b){console.error("[PopupApp] Cannot save flashcard without selected text."),e("Error: No text selected."),c(!0);return}const u={front:m==null?void 0:m.front,back:T??(m==null?void 0:m.back),cloze_text:$??(h==null?void 0:h.text),...l,source_highlight:b,source_url:(d==null?void 0:d.url)||void 0,type:$??(h==null?void 0:h.text)?"cloze":"front_back",target_language:T||$?"zh-CN":void 0,difficulty:l.difficulty??0,stability:l.stability??0,reps:l.reps??0,lapses:l.lapses??0,state:l.state??ie.New,due:l.due??new Date().toISOString(),elapsed_days:l.elapsed_days??0,scheduled_days:l.scheduled_days??0,last_review:l.last_review||void 0};console.log("[PopupApp] Sending saveFlashcardAndNotify message to background:",u),C(!0),e("Saving flashcard..."),c(!1);try{const w=await H("saveFlashcardAndNotify",{cardData:u});if(w)console.log("[PopupApp] Flashcard saved via background:",w),e("Flashcard saved successfully!"),c(!1),setTimeout(window.close,1200);else throw new Error("Background returned null or undefined saving flashcard.")}catch(w){console.error("[PopupApp] Error saving flashcard via background:",w),e(`Error saving flashcard: ${w.message}`),c(!0)}finally{C(!1)}},Z=()=>{window.close()},B=()=>{de.runtime.openOptionsPage()},q=s.useCallback(async l=>{if(!L){console.log("[App] Translating flashcard back:",l),f(!0),E("Translating..."),e("Translating flashcard..."),c(!1);try{const o=await H("translateText",{text:l,targetLang:"Mandarin Chinese"});E(o),e("Translation complete.")}catch(o){console.error("[App] Error translating flashcard back:",o),E("[Translation Error]"),e(`Error: ${o.message||"Translation failed"}`),c(!0)}finally{f(!1)}}},[L]),i=s.useCallback(async l=>{if(!P){console.log("[App] Translating cloze answer from:",l),v(!0),j("Translating..."),e("Translating cloze..."),c(!1);try{const o=l.match(/\{\{c1::(.*?)\}\}/);if(o&&o[1]){const u=o[1],w=await H("translateText",{text:u,targetLang:"Mandarin Chinese"}),oe=l.replace(`{{c1::${u}}}`,`{{c1::${w}}}`);j(oe),e("Translation complete.")}else console.warn("[App] Could not extract cloze answer for translation."),j("[No Answer Found for Translation]"),e("Could not find cloze answer to translate."),c(!0)}catch(o){console.error("[App] Error translating cloze answer:",o),j("[Translation Error]"),e(`Error: ${o.message||"Cloze translation failed"}`),c(!0)}finally{v(!1)}}},[P]);return F?a.jsx("div",{className:"w-80 h-40 flex items-center justify-center p-4",children:a.jsx("p",{className:"text-muted-foreground",children:t||"Loading..."})}):a.jsx("div",{className:"relative min-w-[300px]",children:b?a.jsx(Je,{selectedText:b,onSaveFlashcard:O,onClose:Z,onGenerate:_,generatedFlashcard:m,generatedCloze:h,isGenerating:M,status:t,statusIsError:n,onTranslateFlashcard:q,onTranslateCloze:i,translatedFlashcardBack:T,translatedClozeText:$,isTranslatingFlashcard:L,isTranslatingCloze:P}):d?a.jsx(De,{pageTitle:d.title,pageUrl:d.url,status:t,isSaving:g,canClip:!0,onSaveBookmark:R,saveButtonText:"Save Bookmark",statusIsError:n,tagsValue:k,onTagsChange:G,onSettingsClick:B}):a.jsxs("div",{className:"w-80 h-40 flex flex-col items-center justify-center p-4 text-center",children:[a.jsx("p",{className:te("mb-4",n?"text-destructive":"text-muted-foreground"),children:t||"Cannot access page info."}),a.jsx(z,{variant:"outline",size:"sm",onClick:B,children:"Go to Settings"})]})})}const le=document.getElementById("root");if(!le)throw new Error("Could not find root element to mount React app");const Qe=fe.createRoot(le);Qe.render(a.jsx(r.StrictMode,{children:a.jsx(Ke,{})}));
