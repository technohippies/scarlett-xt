import"./_virtual_wxt-html-plugins-DPbbfBKe.js";import{R as c,r as h,b as I,j as a,c as R,B as P,a as v,g as N,q as D,d as z}from"./db-BxpoVJEC.js";import{r as B}from"./renderRoot-BQDA7FDe.js";import{w as O,k as H,I as Z,T as q,a as U}from"./textarea-wOhmCvPD.js";import{o as X,s as K}from"./messaging-BNKTJYrr.js";const V=new Map([["bold",c.createElement(c.Fragment,null,c.createElement("path",{d:"M230.14,25.86a20,20,0,0,0-19.57-5.11l-.22.07L18.44,79a20,20,0,0,0-3.06,37.25L99,157l40.71,83.65a19.81,19.81,0,0,0,18,11.38c.57,0,1.15,0,1.73-.07A19.82,19.82,0,0,0,177,237.56L235.18,45.65a1.42,1.42,0,0,0,.07-.22A20,20,0,0,0,230.14,25.86ZM156.91,221.07l-34.37-70.64,46-45.95a12,12,0,0,0-17-17l-46,46L34.93,99.09,210,46Z"}))],["duotone",c.createElement(c.Fragment,null,c.createElement("path",{d:"M223.69,42.18l-58.22,192a8,8,0,0,1-14.92,1.25L108,148,20.58,105.45a8,8,0,0,1,1.25-14.92l192-58.22A8,8,0,0,1,223.69,42.18Z",opacity:"0.2"}),c.createElement("path",{d:"M227.32,28.68a16,16,0,0,0-15.66-4.08l-.15,0L19.57,82.84a16,16,0,0,0-2.49,29.8L102,154l41.3,84.87A15.86,15.86,0,0,0,157.74,248q.69,0,1.38-.06a15.88,15.88,0,0,0,14-11.51l58.2-191.94c0-.05,0-.1,0-.15A16,16,0,0,0,227.32,28.68ZM157.83,231.85l-.05.14,0-.07-40.06-82.3,48-48a8,8,0,0,0-11.31-11.31l-48,48L24.08,98.25l-.07,0,.14,0L216,40Z"}))],["fill",c.createElement(c.Fragment,null,c.createElement("path",{d:"M231.4,44.34s0,.1,0,.15l-58.2,191.94a15.88,15.88,0,0,1-14,11.51q-.69.06-1.38.06a15.86,15.86,0,0,1-14.42-9.15L107,164.15a4,4,0,0,1,.77-4.58l57.92-57.92a8,8,0,0,0-11.31-11.31L96.43,148.26a4,4,0,0,1-4.58.77L17.08,112.64a16,16,0,0,1,2.49-29.8l191.94-58.2.15,0A16,16,0,0,1,231.4,44.34Z"}))],["light",c.createElement(c.Fragment,null,c.createElement("path",{d:"M225.88,30.12a13.83,13.83,0,0,0-13.7-3.58l-.11,0L20.14,84.77A14,14,0,0,0,18,110.85l85.56,41.64L145.12,238a13.87,13.87,0,0,0,12.61,8c.4,0,.81,0,1.21-.05a13.9,13.9,0,0,0,12.29-10.09l58.2-191.93,0-.11A13.83,13.83,0,0,0,225.88,30.12Zm-8,10.4L159.73,232.43l0,.11a2,2,0,0,1-3.76.26l-40.68-83.58,49-49a6,6,0,1,0-8.49-8.49l-49,49L23.15,100a2,2,0,0,1,.31-3.74l.11,0L215.48,38.08a1.94,1.94,0,0,1,1.92.52A2,2,0,0,1,217.92,40.52Z"}))],["regular",c.createElement(c.Fragment,null,c.createElement("path",{d:"M227.32,28.68a16,16,0,0,0-15.66-4.08l-.15,0L19.57,82.84a16,16,0,0,0-2.49,29.8L102,154l41.3,84.87A15.86,15.86,0,0,0,157.74,248q.69,0,1.38-.06a15.88,15.88,0,0,0,14-11.51l58.2-191.94c0-.05,0-.1,0-.15A16,16,0,0,0,227.32,28.68ZM157.83,231.85l-.05.14,0-.07-40.06-82.3,48-48a8,8,0,0,0-11.31-11.31l-48,48L24.08,98.25l-.07,0,.14,0L216,40Z"}))],["thin",c.createElement(c.Fragment,null,c.createElement("path",{d:"M224.47,31.52a11.87,11.87,0,0,0-11.82-3L20.74,86.67a12,12,0,0,0-1.91,22.38L105,151l41.92,86.15A11.88,11.88,0,0,0,157.74,244c.34,0,.69,0,1,0a11.89,11.89,0,0,0,10.52-8.63l58.21-192,0-.08A11.85,11.85,0,0,0,224.47,31.52Zm-4.62,9.54-58.23,192a4,4,0,0,1-7.48.59l-41.3-84.86,50-50a4,4,0,1,0-5.66-5.66l-50,50-84.9-41.31a3.88,3.88,0,0,1-2.27-4,3.93,3.93,0,0,1,3-3.54L214.9,36.16A3.93,3.93,0,0,1,216,36a4,4,0,0,1,2.79,1.19A3.93,3.93,0,0,1,219.85,41.06Z"}))]]);var J=Object.defineProperty,W=Object.defineProperties,G=Object.getOwnPropertyDescriptors,k=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,E=(e,s,t)=>s in e?J(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,ee=(e,s)=>{for(var t in s||(s={}))Q.call(s,t)&&E(e,t,s[t]);if(k)for(var t of k(s))Y.call(s,t)&&E(e,t,s[t]);return e},ae=(e,s)=>W(e,G(s));const $=h.forwardRef((e,s)=>c.createElement(I,ae(ee({ref:s},e),{weights:V})));$.displayName="PaperPlaneTilt";const se=({role:e,content:s,isError:t=!1})=>{const l=e==="user",o="py-2 rounded-lg max-w-[85%] text-base leading-relaxed break-words",i=e==="user"?"bg-gray-400 text-gray-900 self-end px-4":t?"bg-red-100 text-red-800 border border-red-200 self-start px-4":e==="assistant"||e==="system"?"text-neutral-100 self-start":"bg-blue-100 text-blue-800 self-start px-4",d=l?"justify-end":"justify-start";return a.jsx("div",{className:`flex w-full my-2 ${d}`,children:a.jsx("div",{className:R(o,i),children:a.jsx("p",{className:"whitespace-pre-wrap",children:s??""})})})},te=()=>a.jsx("div",{className:"flex w-full my-2 justify-start",children:a.jsx("div",{className:R("py-2 px-4 rounded-lg max-w-[85%] text-base","self-start"),children:a.jsxs("div",{className:"flex space-x-1 items-center",children:[a.jsx("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-pulse [animation-delay:-0.3s]"}),a.jsx("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-pulse [animation-delay:-0.15s]"}),a.jsx("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-pulse"})]})})}),ne=30,L=25,C=(e,s)=>e?e.length>s?`${e.substring(0,s)}...`:e:"",re=({bookmark:e})=>{const{id:s,title:t,url:l}=e;if(!l)return console.warn("BookmarkChatMessage requires a bookmark with a url."),null;let o="";try{o=new URL(l).hostname,o=o.replace(/^www\./i,"")}catch(x){console.warn(`Invalid URL provided to BookmarkChatMessage: ${l}`,x),o=C(l,L)}const i=C(t,ne),d=C(o,L),p=`${t||"(No Title)"} | ${l}`;return a.jsx("div",{className:"flex w-full my-2 justify-start",children:a.jsxs("div",{className:"flex items-center gap-2 my-1 px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200 text-sm self-start max-w-[85%]",title:p,children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx(O,{size:24,weight:"duotone",className:"text-red-500"})}),a.jsxs("div",{className:"flex-grow min-w-0",children:[a.jsx("span",{className:"text-gray-900",children:i||"(No Title)"}),a.jsxs("span",{className:"text-gray-600",children:[" | ",d]})]})]},`bm-msg-${s}`)})},S=60,le=(e,s)=>e?e.length>s?`${e.substring(0,s)}...`:e:"",oe=e=>e?e.length>S?le(e,S):e:"[Empty Cloze Text]",ce=({flashcard:e})=>{const{id:s,cloze_text:t,source_highlight:l,source_url:o}=e;if(!t)return console.warn("FlashcardClozeMessage requires flashcard with cloze_text."),null;const i=oe(t);let d=`Flashcard (Cloze)
Text: ${t}`;return l&&(d+=`
Highlight: ${l}`),o&&(d+=`
Source: ${o}`),a.jsx("div",{className:"flex w-full my-2 justify-start",children:a.jsxs("div",{className:"inline-flex items-center gap-2 my-1 px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200 text-sm self-start max-w-[85%]",title:d,children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx(H,{size:24,weight:"duotone",className:"text-orange-500"})}),a.jsx("div",{className:"flex-grow min-w-0",children:a.jsx("span",{className:"text-gray-800",children:i})})]},`fc-msg-${s}`)})},ie=25,de=20,M=(e,s)=>e?e.length>s?`${e.substring(0,s)}...`:e:"",ue=({flashcard:e})=>{const{id:s,front:t,back:l,source_highlight:o,source_url:i}=e;if(!t&&!l)return console.warn("FlashcardFrontBackMessage requires flashcard with at least front or back text."),null;const d=M(t,ie),p=M(l,de);let x=`Flashcard (Front/Back)
Front: ${t||"[Empty]"}
Back: ${l||"[Empty]"}`;return o&&(x+=`
Highlight: ${o}`),i&&(x+=`
Source: ${i}`),a.jsx("div",{className:"flex w-full my-2 justify-start",children:a.jsxs("div",{className:"inline-flex items-center gap-2 my-1 px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200 text-sm self-start max-w-[85%]",title:x,children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx(Z,{size:24,weight:"duotone",className:"text-orange-500"})}),a.jsxs("div",{className:"flex-grow min-w-0",children:[d&&a.jsx("span",{className:"text-gray-800",children:d}),d&&p&&a.jsx("span",{className:"text-gray-400 mx-1",children:"|"}),p&&a.jsx("span",{className:"text-gray-500",children:p})]})]},`fb-msg-${s}`)})},ge=({value:e,onChange:s,onSend:t,isLoading:l})=>{const o=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),l||t())};return a.jsxs("div",{className:"flex items-end space-x-2",children:[a.jsx(q,{placeholder:"Send a message...",value:e,onChange:s,onKeyDown:o,rows:1,className:"flex-1 resize-none min-h-[40px] max-h-[200px] overflow-y-auto rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:l}),a.jsx(P,{type:"button",size:"icon",onClick:t,disabled:l||!e.trim(),"aria-label":"Send message",children:a.jsx($,{size:18})})]})},me=()=>{const[e,s]=h.useState([]),[t,l]=h.useState(""),[o,i]=h.useState(!1),[d,p]=h.useState(!0),x=h.useRef(null),[b,A]=h.useState(!1),w=h.useRef("");h.useEffect(()=>{var n;(n=x.current)==null||n.scrollIntoView({behavior:"smooth"})},[e]),h.useEffect(()=>{(async()=>{var r,g;p(!0);let y=!1;try{const u=await D("SELECT config_json FROM user_configuration WHERE id = 1;");if(console.log("[ChatPage] Raw DB Result for config:",u),(g=(r=u==null?void 0:u.rows)==null?void 0:r[0])!=null&&g.config_json){const j=JSON.parse(u.rows[0].config_json);console.log("[ChatPage] Loaded User Configuration from DB:",j),A(!0),y=!0}else console.log("[ChatPage] No user configuration found in DB.");const f=await N();s(f),console.log(`[ChatPage] Loaded ${f.length} chat history items.`)}catch(m){console.error("[ChatPage] Error loading initial data from DB:",m)}finally{p(!1)}})()},[]),h.useEffect(()=>{console.log("[ChatPage] Setting up ollamaResponse listener."),w.current="";const n=X("ollamaResponse",async y=>{const r=y.data;if(console.log("[ChatPage] Received ollamaResponse chunk:",r),r.status==="chunk"&&r.content){const g=e[e.length-1];g&&g.type==="message"&&g.data.role==="assistant"&&g.data.id===-1||(console.log("[ChatPage] First chunk detected, setting isLoading to false."),i(!1)),s(m=>{const u=m[m.length-1];if(u&&u.type==="message"&&u.data.role==="assistant"&&u.data.id===-1)return m.map((f,j)=>j===m.length-1&&f.type==="message"?{...f,data:{...f.data,content:(f.data.content??"")+r.content}}:f);{const f={type:"message",data:{id:-1,role:"assistant",content:r.content,timestamp:new Date().toISOString()}};return[...m,f]}}),w.current+=r.content}else if(r.status==="complete"||r.status==="error"||r.status==="done"){const g=w.current;if(w.current="",s(m=>m.filter(u=>u.type==="message"?u.data.id!==-1:!0)),g.trim()||r.status==="error"){let m=g.trim();if(r.status==="error"&&(m+=`

Error: ${r.error||"Unknown Error"}`),m)try{console.log("[ChatPage] Saving final assistant message to DB..."),await v({role:"assistant",content:m}),console.log("[ChatPage] Refetching history after assistant message saved.");const u=await N();s(u)}catch(u){console.error("[ChatPage] Failed to save final assistant message to DB:",u),s(f=>[...f,{type:"message",data:{id:Date.now(),role:"assistant",content:m,timestamp:new Date().toISOString()}}])}}else console.log("[ChatPage] No final content, not saving empty message."),i(!1)}else console.warn("[ChatPage] Received unexpected or incomplete ollamaResponse chunk format:",r)});return()=>{console.log("[ChatPage] Cleaning up ollamaResponse listener."),w.current&&console.warn("[ChatPage] Unmounting with accumulated response - message not saved. Content:",w.current),n()}},[]);const T=n=>{l(n.target.value)},F=h.useCallback(async()=>{const n=t.trim();if(!n||o||!b||d){b||console.warn("[ChatPage] Cannot send message: Config not loaded yet."),d&&console.warn("[ChatPage] Cannot send message: History still loading.");return}const y={type:"message",data:{id:Date.now(),role:"user",content:n,timestamp:new Date().toISOString()}};s(r=>[...r,y]),l(""),i(!0);try{await v({role:"user",content:n}),console.log("[ChatPage] Sending ollamaChatRequest to background.");const r=e.flatMap(g=>g.type==="message"&&(g.data.role==="user"||g.data.role==="assistant")?[{role:g.data.role,content:g.data.content??""}]:[]);await K("ollamaChatRequest",{prompt:n,history:r})}catch(r){console.error("[ChatPage] Error during send process (saving/sending): ",r),i(!1)}},[t,o,e,b,d]),_=()=>{z.runtime.openOptionsPage()};return a.jsxs("div",{className:"flex h-screen flex-col bg-background text-foreground",children:[a.jsx("header",{className:"sticky top-0 z-10 flex h-[57px] items-center justify-end border-b bg-background px-4",children:a.jsx(P,{variant:"ghost",size:"icon",onClick:_,"aria-label":"Settings",children:a.jsx(U,{size:20})})}),a.jsxs("main",{className:"flex-1 overflow-y-auto p-4 md:p-6",children:[a.jsxs("div",{className:"mx-auto max-w-3xl",children:[d?a.jsx("div",{className:"flex justify-center items-center h-full",children:a.jsx("p",{className:"text-muted-foreground",children:"Loading history..."})}):e.length===0&&!o?a.jsx("div",{className:"flex justify-center items-center h-full",children:a.jsx("p",{className:"text-muted-foreground",children:"Start chatting with Scarlett..."})}):e.map(n=>{switch(n.type==="message"&&(n.data.id===null||n.data.id===void 0)&&console.error("[ChatPage Render] Found message item with null/undefined ID:",n),n.type){case"message":const y=`msg-${n.data.id??n.data.timestamp??Math.random()}`;return a.jsx(se,{role:n.data.role,content:n.data.content},y);case"bookmark":return a.jsx(re,{bookmark:n.bookmark},`bm-${n.message.id}`);case"flashcard":return n.flashcard.type==="cloze"?a.jsx(ce,{flashcard:n.flashcard},`fc-${n.message.id}`):n.flashcard.type==="front_back"?a.jsx(ue,{flashcard:n.flashcard},`fb-${n.message.id}`):(console.warn(`[ChatPage Render] Unhandled flashcard type: ${n.flashcard.type}`),null)}}),o&&a.jsx(te,{})]}),a.jsx("div",{ref:x})]}),a.jsx("footer",{className:"sticky bottom-0 z-10 border-t bg-background p-4 md:p-6",children:a.jsx("div",{className:"mx-auto max-w-3xl",children:a.jsx(ge,{value:t,onChange:T,onSend:F,isLoading:o||d})})})]})};B(a.jsx(me,{}));
